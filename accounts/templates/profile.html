{% extends 'base.html' %}
{% load static %}
{% block title %}{{ user.first_name|title }}'s Profile{% endblock %}
{% load crispy_forms_tags %}

{% block css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-horizon/0.1.1/bootstrap-horizon.css">
{% endblock %}

{% block head_js %}
<script type="text/javascript" src="https://js.stripe.com/v3/"></script>
{% endblock %}

{% block content %}
<div class="event-container layout">
    <h3>Hi {{ user.first_name|title }}</h3>
    <p class="membership-info">
    {% if membership.bronze %}
        Your membership is<span class="bronze-text"><strong> BRONZE</strong></span>, you can join as many exciting events as you like!
    {% else %}
        Your membership is{% if membership.silver %}<span class="silver-text"><strong> SILVER{% else %}<span class="gold-text"><strong> GOLD{% endif %}</strong></span>, you have {{ membership.posts_remaining }} {% if membership.posts_remaining != 1 %} posts {% else %} post {% endif %} remaining.
    {% endif %} 
    </p>
    <div class="divider"></div>
    <div class="profile-button">
        <button class="btn btn-primary btn-lg btn-block" type="button" data-toggle="collapse" data-target="#edit_user" aria-expanded="false" aria-controls="collapseExample">Edit your details <i class="fas fa-user-edit"></i></button>
        <div class="collapse" id="edit_user">
            <div class="card card-body">
                <form method="POST">
                    <div class="row filter-row">
                    {% csrf_token %}
                    {{edit_form|crispy }}
                    </div>
                    <button action="submit" class="btn btn-primary float-right">Submit</button>
                </form>
            </div>
        </div>
    </div>
    <div class="profile-button">
        <button class="btn btn-primary btn-lg btn-block" type="button" data-toggle="collapse" data-target="#change_membership" aria-expanded="false" aria-controls="collapseExample">Edit/ Upgrade your membership <i class="fas fa-medal"></i></button>
        <div class="collapse" id="change_membership">
            <div class="row card-row">
                <div class="col-sm-4 mem-card">
                    <div class="card">
                        <ul class="price">
                            <li class="header bronze-header"><strong>BRONZE</strong></li>
                            <li class="bronze-text"><strong>Free</strong></li>
                            <li>Join Events</li>
                            <li>N/A</li>
                            {% if membership.bronze %}
                            <li class="grey"><button class="btn btn-secondary btn-block" disabled>Enjoy!</button></li>
                            {% else %}
                            <li class="grey"><button type="button" class="btn btn-primary btn-block" data-toggle="modal" data-target="#exampleModal" data-level="bronze">Change</button></li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
                <div class="col-sm-4 mem-card">
                    <div class="card">
                        <ul class="price">
                            <li class="header silver-header"><strong>SILVER</strong></li>
                            <li class="silver-text"><strong>£20</strong></li>
                            <li>Join and Post Events</li>
                            <li>2 Posts</li>
                            <li class="grey"><button type="button" class="btn btn-primary btn-block" data-toggle="modal" data-target="#exampleModal" data-level="silver">Purchase</button></li>
                        </ul>
                    </div>
                </div>
                <div class="col-sm-4 mem-card">
                    <div class="card">
                        <ul class="price">
                            <li class="header gold-header"><strong>GOLD</strong></li>
                            <li class="gold-text"><strong>£120</strong></li>
                            <li>Join and Post Events</li>
                            <li>15 Posts</li>
                            <li class="grey"><button type="button" class="btn btn-primary btn-block" data-toggle="modal" data-target="#exampleModal" data-level="gold">Purchase</button></li>
                        </ul>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    <div class="profile-button">
        <button class="btn btn-primary btn-lg btn-block" type="button" data-toggle="collapse" data-target="#liked_events" aria-expanded="false" aria-controls="collapseExample">Your Saved Events <i class="fas fa-heart"></i></button>
        <div class="collapse" id="liked_events">
            <div class="card card-body h-scroll">
                <div class="container-fluid">
                    <div class="row flex-row flex-nowrap">
                    {% for event in user_liked_events %}
                        {% include "view_events_partial.html" %}
                    {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    <div class="profile-button">
        <button class="btn btn-primary btn-lg btn-block" type="button" data-toggle="collapse" data-target="#booked_events" aria-expanded="false" aria-controls="collapseExample">Your Booked Events <i class="far fa-calendar-alt"></i></button>
        <div class="collapse" id="booked_events">
            <div class="card card-body">
                <div class="row row-horizon">
                {% for event in user_participant_events %}
                    {% include "view_events_partial.html" %}
                {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="profile-button">
        <button class="btn btn-primary btn-lg btn-block" type="button" data-toggle="collapse" data-target="#event_history" aria-expanded="false" aria-controls="collapseExample">Event History <i class="fas fa-history"></i></button>
        <div class="collapse" id="event_history">
            <div class="card card-body">
                
            </div>
        </div>
    </div>
    <div class="divider"></div>
    {% if membership.silver or membership.gold %}
    <div class="profile-button">
        <button class="btn btn-success btn-lg btn-block" type="button" data-toggle="collapse" data-target="#event_hosting" aria-expanded="false" aria-controls="collapseExample">Your Events <i class="fas fa-history"></i></button>
        <div class="collapse" id="event_hosting">
            <div class="card card-body">
                
            </div>
        </div>
    </div>
    <div class="profile-button">
        <button class="btn btn-success btn-lg btn-block" type="button" data-toggle="collapse" data-target="#post_event" aria-expanded="false" aria-controls="collapseExample">Post a New Event <i class="fas fa-history"></i></button>
        <div class="collapse" id="post_event">
            <div class="card card-body">
                
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!--Modal for membership upgrade-->

<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
            </div>
            <div class="modal-body">
                <!--Form will display for changing to bronze membership-->
                <form method="POST" id="bronze-form" action="{% url 'membership' 'bronze' %}">
                    {% csrf_token %} 
                    {{ order_form|crispy }}
                    <button type="submit" class="btn btn-primary btn-block btn-lg">Submit Request</button>    
                </form>
                
                <!--Form with payment element will display for changing to silver or gold membership-->
                <form method="POST" id="payment-form" action="" data-token="{{ publishable }}">
                    {% csrf_token %} 
                    {{ order_form|crispy }}
                    <fieldset class="form-group">
                        <label for="card-element" class="col-form-label">Credit or Debit Card</label>
                        <!-- Stripe widget inserted below -->
                        <div id="card-element" class="textinput textInput form-control"></div>
                        <div id="card-errors" class="white-text red" role="alert"></div>
                        <div class="card-action">
                            <button type="submit" class="btn btn-primary btn-block btn-lg">Submit Payment</button>
                        </div>
                    </fieldset>
                </form>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

{% block js %}
<script>
    $('#exampleModal').on('show.bs.modal', function(event) {
    var button = $(event.relatedTarget) // Button that triggered the modal
    var membership_level = button.data('level'); // Extract info from data-* attributes
    
    // Update modal with required membership forms
    var modal = $(this)
    modal.find('.modal-title').html(`You've chosen to be a<span class="${membership_level}-text"><strong> ${membership_level.toUpperCase()}</strong></span> member!`);
    
    if (membership_level === 'bronze') {
        modal.find('#payment-form').css('display', 'none');
        modal.find('#bronze-form').css('display', 'block');
    }
    else if (membership_level === 'silver') {
        modal.find('#payment-form').css('display', 'block');
        modal.find('#bronze-form').css('display', 'none');
        modal.find('form').attr('action', "{% url 'membership' 'silver' %}");
    }
    else {
        modal.find('#payment-form').css('display', 'block');
        modal.find('#bronze-form').css('display', 'none');
        modal.find('form').attr('action', "{% url 'membership' 'gold' %}");
    }
});
    
</script>
<!--Stripe JS below will handle display of card element in modal form-->
<script type="text/javascript" src="{% static 'js/stripe.js' %}"></script>

{% endblock %}
{% endblock %}


